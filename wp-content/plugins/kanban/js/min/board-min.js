function Board(t,r){(null==r||isNaN(r))&&(r=50),$(document).trigger("/board/init/",t),this.record=t,this.$el=$("#board-{0}".sprintf(t.id()));var s=new User(this.record.allowed_users()[this.record.current_user_id()]);this.current_user=function(){return s},this.dom();var e=this;setTimeout(function(){var t=obj_order_by_prop(e.record.tasks,"position",!0);for(var r in t){var s=t[r];(e.record.tasks[s.id]=new Task(e.record.tasks[s.id])).add_to_board()}e.update_UI(),$(document).trigger("/board/tasks/done/",e)},r)}Board.prototype.dom=function(){var t=this;if($(document).trigger("/board/dom/",t.$el),t.$el.on("click",".col-tasks-sidebar",function(r){if("click"==r.type&&kanban.is_dragging)return!1;var s=$(this),e=$(".row-statuses, .row-tasks",t.$el);if(e.is(":animated"))return!1;var a=s.attr("data-left"),o=s.attr("data-right");return s.hasClass("opened")?(s.removeClass("opened"),a=o):s.addClass("opened"),$(".col-tasks-sidebar",t.$el).not(s).removeClass("opened"),e.animate({marginLeft:a},300),!1}),t.$el.on("change",".modal-filter select",function(){var r=$(this),s=r.attr("data-field"),e=r.val();return t.record.filters[s]=e,t.apply_filters(),!1}).on("show.bs.modal",".modal-filter",function(){var r=$(this),s=$(".select-projects",r),e=$("option:first",s),a=$("option:last",s);$("option",s).not(e).not(a).remove();for(var o in t.record.project_records){var i=t.record.project_records[o],d=kanban.templates[t.record.id()]["t-option-project"].render(i);$(d).insertAfter(e),t.apply_filters()}}),t.$el.on("click",".btn-status-toggle",function(){var r=$(this),s=r.closest(".col"),e=s.siblings().andSelf(),a=parseInt(r.attr("data-operator")),o=s.index()+a;o<0&&(o=e.length-1),o>=e.length&&(o=0),t.status_cols_toggle(o)}),!t.current_user().has_cap("write"))return!1;$(".col-tasks",t.$el).sortable({connectWith:".col-tasks",handle:".task-handle",forcePlaceholderSize:!0,forceHelperSize:!0,placeholder:"task-placeholder",containment:$(".row-tasks-wrapper",t.$el),appendTo:"body",scroll:!1,helper:"clone",start:function(r,s){$(".dropdown.open",t.$el).removeClass("open").closest(".col-tasks.active").removeClass("active"),$(".col-tasks-sidebar").css({left:"",right:""}),kanban.is_dragging=!0},stop:function(r,s){t.update_task_positions(s.item),kanban.is_dragging=!1},receive:function(r,s){var e=s.item.closest(".col-tasks"),a=s.item.attr("data-id"),o=t.record.tasks[a],i=o.record.status_id,d=t.record.status_records()[i],n=e.attr("data-status-id"),c=t.record.status_records()[n],u=0;if(void 0!==c.wip_task_limit&&(u=c.wip_task_limit),u>0){if($("#status-"+n+" .status-task-count").text()>=u)return $(s.sender).sortable("cancel"),notify(kanban.text.status_wip_task_limit_error,"warning"),!1}var l=kanban.text.task_moved_to_status.sprintf(t.current_user().record().short_name,c.title);l+=kanban.text.task_moved_to_status_previous.sprintf(d.title),void 0!==t.record.settings().default_assigned_to_first&&(1!=t.record.settings().default_assigned_to_first||void 0!==o.record.user_id_assigned&&0!=o.record.user_id_assigned||(o.record.user_id_assigned=t.current_user().record().ID,o.update_assigned_to(t.current_user().record().ID))),o.record.status_id=n,o.save(l),t.record.tasks[a].update_status(n),t.update_UI()}}),t.$el.on("mouseenter",".col-tasks",function(){var t=$(this),r=t.attr("data-status-id");return $("#status-"+r).trigger("mouseenter"),!1}).on("mouseleave",".col-tasks",function(){var t=$(this),r=t.attr("data-status-id");return $("#status-"+r).trigger("mouseleave"),!1}).on("shown.bs.dropdown",".col-tasks .dropdown",function(){return $(this).closest(".col-tasks").addClass("active"),!1}).on("hidden.bs.dropdown",".col-tasks .dropdown",function(){return $(this).closest(".col-tasks").removeClass("active"),!1}),t.$el.on("mouseenter",".col-status",function(){var t=$(this),r=t.attr("data-id");return $(".btn-group-status-actions",t).show(),!1}).on("mouseleave",".col-status",function(){var t=$(this),r=t.attr("data-id");return $(".btn-group-status-actions",t).hide(),!1}),t.$el.on("click",".btn-task-new",function(){var r=$(this);$(".glyphicon",r).toggle();var s=r.attr("data-status-id"),e=t.record.status_records()[s],a=0;if(void 0!==e.wip_task_limit&&(a=e.wip_task_limit),a>0){if($("#status-"+s+" .status-task-count").text()>=a)return notify(kanban.text.status_wip_task_limit_error,"warning"),!1}var o={task:{status_id:s,board_id:t.record.id()},comment:"{0} added the task".sprintf(t.current_user().record().short_name)};void 0!==t.record.settings().default_estimate&&void 0!==t.record.estimate_records()[t.record.settings().default_estimate]&&(o.task.estimate_id=t.record.settings().default_estimate);try{1==t.record.settings().default_assigned_to_creator&&(o.task.user_id_assigned=t.current_user().record().ID)}catch(t){}if(void 0!==t.record.settings().default_assigned_to&&void 0!==t.record.allowed_users()[t.record.settings().default_assigned_to]){var i=!0;try{1!=t.record.settings().default_assigned_to_creator&&1!=t.record.settings().default_assigned_to_first||(i=!1)}catch(t){}i&&(o.task.user_id_assigned=t.record.settings().default_assigned_to)}return o.action="save_task",o.kanban_nonce=$("#kanban_nonce").val(),$.ajax({method:"POST",url:kanban.ajaxurl,data:o}).done(function(s){$(".glyphicon",r).toggle();try{if(!s.success)return notify(kanban.text.task_added_error),!1;0===Object.keys(t.record.tasks).length&&(t.record.tasks={});(t.record.tasks[s.data.task.id]=new Task(s.data.task)).add_to_board(),t.update_UI(),t.update_task_positions(),$(".task-title",t.record.tasks[s.data.task.id].$el).trigger("click")}catch(t){}}),!1}),t.$el.on("click",".btn-status-empty",function(){if(window.confirm(kanban.text.status_empty_confirm)){var r=$(this),s=r.attr("data-status-id");$(".glyphicon",r).toggle();for(var e in t.record.tasks){var a=t.record.tasks[e];a.record.status_id==s&&a.delete()}setTimeout(function(){$(".glyphicon",r).toggle()},2e3)}return!1}),t.$el.on("click",".modal-task-move .list-group-item",function(){var r=$(this),s=r.closest(".modal"),e=$("input.task-id",s),a=e.val(),o=t.record.tasks[a],i=r.attr("data-status-id");if(o.record.status_id!=i){o.record.status_id=i;var d=r.attr("data-board-id");if(o.record.board_id!=d){var n=parseInt(o.record.board_id+"");o.record.board_id=d,boards[d].record.tasks[a]=o,delete boards[n].record.tasks[a]}o.save();var c=$("#task-"+a);setTimeout(function(){c.slideUp("fast",function(){o.update_status(i),$(this).prependTo("#status-"+i+"-tasks").slideDown("fast",function(){$(".btn-task-move",this).attr("data-target","#modal-task-move-"+d),t.update_UI()})})},300),t.match_col_h(),t.updates_status_counts()}}),$(window).resize(function(){$(".col-tasks",t.$el).sortable("xs"==screen_size?"disable":"enable")}),$(".col-tasks",t.$el).sortable("xs"==screen_size?"disable":"enable")},Board.prototype.updates_status_counts=function(){$(".col-tasks",this.$el).each(function(){var t=$(this),r=$(".task",t).length,s=t.attr("data-status-id");$("#status-"+s+" .status-task-count").text(r)})},Board.prototype.update_card_order=function(){var t=this;$(".col-tasks",this.$el).each(function(){var r=$(this),s=r.children(".task").get();s.sort(function(r,s){var e=$(r).attr("data-id"),a=t.record.tasks[e],o=parseInt(a.record.position),i=$(s).attr("data-id"),d=t.record.tasks[i],n=parseInt(d.record.position);return o<n?-1:o>n?1:0}),$.each(s,function(t,s){r.append(s)})})},Board.prototype.update_task_positions=function(t){var r=this;$(".col-tasks",this.$el).each(function(){var s=$(this);$(".task",s).each(function(s){var e=$(this),a=!1;e.is(t)&&(a=!0);var o=e.attr("data-id");r.record.tasks[o].update_position(("00000"+s).slice(-5),a)})})},Board.prototype.match_col_h=function(){$(".col-tasks",this.$el).matchHeight({minHeight:window_h})},Board.prototype.apply_filters=function(){var t=this,r=[],s=!1;for(var e in this.record.filters){var a=this.record.filters[e];if(null!==a&&""!==a){s=!0;for(var o in this.record.tasks){this.record.tasks[o].record[e]!=a&&r.push("#task-"+o)}$('.modal-filter select[data-field="{0}"]'.sprintf(e),this.$el).val(a)}}s?$(".btn-filter-reset").show():$(".btn-filter-reset").hide();var i=$(r.join(","));i.slideUp("fast"),$(".task").not(i).slideDown("fast"),$(".task",this.$el).promise().done(function(){t.match_col_h()}),kanban.url_params=$.extend(kanban.url_params,{filters:this.record.filters}),update_url()},Board.prototype.project_update_counts=function(){var t=[];for(var r in this.record.tasks){var s=this.record.tasks[r];void 0!==s.record.project_id&&(void 0===t[s.record.project_id]&&(t[s.record.project_id]=0),t[s.record.project_id]++)}for(var e in this.record.project_records)void 0!==t[e]?this.record.project_records[e].task_count=t[e]:this.record.project_records[e].task_count=0},Board.prototype.update_UI=function(){this.update_card_order(),this.update_card_order(),this.updates_status_counts(),this.match_col_h()},Board.prototype.status_cols_toggle=function(t){kanban.url_params.col_index=t,update_url(),$(".row-statuses, .row-tasks",this.$el).each(function(){var r=$(this),s=$("> .col",r),e=s.eq(t).show();s.not(e).hide()})},Board.prototype.status_cols_show_all=function(){$(".row-statuses, .row-tasks",this.$el).each(function(){var t=$(this);$("> .col",t).show()})},Board.prototype.get_current_board_id=function(){return parseInt(current_board_id)},Board.prototype.get_current_board=function(){var t=Board.prototype.get_current_board_id();return void 0!==boards[t]&&boards[t]};